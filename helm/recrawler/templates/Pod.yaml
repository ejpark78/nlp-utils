{{- range $jobIndex, $job := .Values.jobs }}
{{- range $CategoryIndex, $subCategory := $job.subSategory }}
---
apiVersion: v1
kind: Pod
metadata:
  name: "{{ $.Release.Name }}-{{ $job.name }}-{{ $CategoryIndex }}"
  labels:
    app: {{ $job.name }}
    release: {{ $.Release.Name }}
    namespace: {{ $.Release.Namespace }}
spec:
  tolerations:
    - key: node-role.kubernetes.io/master
      effect: NoSchedule
  restartPolicy: {{ $.Values.restartPolicy }}
  hostAliases:
    {{- toYaml $.Values.hostAliases | nindent 2 }}
  imagePullSecrets:
    - name: "{{ $.Release.Name }}-{{ $.Values.imagePullSecrets }}"
  containers:
  - name: app
    resources:
      {{- toYaml $.Values.resources | nindent 5 }}
    image: {{ $.Values.image }}
    imagePullPolicy: Always
    env:
      - name: ELASTIC_SEARCH_AUTH
        valueFrom:
          secretKeyRef:
            name: "{{ $.Release.Name }}-{{ $.Values.secret.name }}"
            key: http_auth
    envFrom:
      - configMapRef:
          name: "{{ $.Release.Name }}-{{ $.Values.configMap.name }}"
    args:
      {{- toYaml $.Values.args | nindent 6 }}
      {{- toYaml $job.args | nindent 6 }}
      - --sub-category
      - {{ $subCategory }}
{{- end }}
{{- end }}
