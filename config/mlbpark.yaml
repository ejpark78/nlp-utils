---
jobs:
  - name: kbo
    index: crawler-bbs-mlbpark_kbo-{year}
    article:
      document_id:
        frame: '{id}'
        type: query
    args:
      page_range: "1~300"
      page_step: "30"
    list:
      - category: KBO
        url_frame: http://mlbpark.donga.com/mp/b.php?p={page}&m=list&b=kbotown&query=&select=&user=

  - name: mlb
    index: crawler-bbs-mlbpark_mlb-{year}
    article:
      document_id:
        frame: '{id}'
        type: query
    args:
      page_range: "1~300"
      page_step: "30"
    list:
      - category: MLB
        url_frame: http://mlbpark.donga.com/mp/b.php?p={page}&m=list&b=mlbtown&query=&select=&user=

  - name: bullpen
    index: crawler-bbs-mlbpark_bullpen-{year}
    article:
      document_id:
        frame: '{id}'
        type: query
    args:
      page_range: "1~300"
      page_step: "30"
    list:
      - category: BULLPEN
        url_frame: http://mlbpark.donga.com/mp/b.php?p={page}&m=list&b=bullpen&query=&select=&user=

# crawling 과정에서 추출하는 정보
parsing:
  version: v2021-03-17
  parser: html5lib

  # 전체 html 에서 추출해야하는 전체 tag 목록
  trace:
    - select: table.tbl_type01 tr

  # 기사 목록에서 추출해야하는 하나의 기사 정보
  list:
    - key: raw_list
      value: [ ]
      type: html
    - key: title
      value:
        - select: div.tit a
      type: title
      convert:
        merge: single
    - key: url
      value:
        - select: div.tit a
      type: href
      convert:
        merge: single
    - key: date
      value:
        - select: span.date
      type: text
      convert:
        to: date
        merge: single
    - key: '@curl_list'
      value:
        - const: DATE_NOW

  # 기사 본문에서 추출해야하는 tag 정보
  article:
    - key: raw
      value:
        - name: html
      remove:
        - name: style
        - name: comment
      type: html
    - key: title
      remove:
        - select: span.word
      value:
        - select: div.left_cont div.titles
      type: text
    - key: date
      value:
        - select: ul.view_head div.text div.text_right div.text3 span.val
      type: text
      convert:
        to: date
        merge: single
    - key: contents
      value:
        - select: div.view_context div#contentDetail
      type: text
      convert:
        merge: merge
    - key: '@curl_date'
      value:
        - const: DATE_NOW

# ETL pipeline: raw, raw_list 에서 추출하는 정보
pipeline:
  common:
    - column: raw_list
      key: title_header
      value:
        - select: span.word
      type: text
    - column: raw_list
      key: reply_count
      replace:
        - from: '[[]'
          to: ''
        - from: '[]]'
          to: ''
      value:
        - select: span.replycnt
      type: text
    - column: raw
      key: title_header
      value:
        - select: div.left_cont div.titles span.word
      type: text
    - column: raw
      key: good_count
      replace:
        - from: ^.*추천 ([0-9]+).*$
          to: \g<1>
      value:
        - select: ul.view_head div.text div.text_left div.text2
      type: text
    - column: raw
      key: view_count
      replace:
        - from: ^.*조회 ([0-9]+).*$
          to: \g<1>
      value:
        - select: ul.view_head div.text div.text_left div.text2
      type: text
    - column: raw
      key: author
      replace:
        - from: 입력.+$
          to: ''
      value:
        - select: ul.view_head div.text div.text_left span.nick
      type: text
    # bullpen
    - key: title_header
      value:
      - select: span.word_bullpen
      type: text

  reply:
    - column: raw
      key: reply_list.text
      value:
        - select: div.reply_list div.txt_box span.re_txt
      type: text
    - column: raw
      key: reply_list.author
      value:
        - select: div.reply_list div.txt_box span.name
      type: text
    - column: raw
      key: reply_list.date
      value:
        - select: div.reply_list div.txt_box span.date
      type: text
      convert:
        to: date

# 인덱스 맵핑
index_mapping:
  settings:
    number_of_replicas: 1
    number_of_shards: 1
  mappings:
    properties:
      title:
        type: text
      url:
        ignore_above: 256
        type: keyword
      contents:
        type: text
      date:
        type: date
      category:
        ignore_above: 50
        type: keyword
      raw:
        enabled: false
      raw_list:
        enabled: false
      parser_version:
        ignore_above: 50
        type: keyword
      status:
        # raw_list, raw, pipeline
        ignore_above: 50
        type: keyword
      '@curl_list':
        type: date
      '@curl_date':
        type: date
